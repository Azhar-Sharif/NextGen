{% extends "base.html" %}

{% block content %}
<div class="interview-container">

    <!-- Question Section -->
    <div class="question-section">
        <h2>Current Question:</h2>
        <p id="questionText" class="question-text">{{ first_question }}</p>
    </div>

    <!-- Hidden Audio Player -->
    <audio id="question-audio" autoplay>
        <source id="audioSource" src="{{ question_audio }}" type="audio/mp3">
        Your browser does not support the audio element. Please use a modern browser.
    </audio>

    <!-- Controls -->
    <div class="controls">
        <button id="nextButton" class="btn btn-primary">Next</button>
        <button id="recordButton" class="btn btn-secondary">Start Recording</button>
        <button id="submitButton" class="btn btn-success" disabled>Submit Answer</button>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const socket = io(); // Initialize WebSocket connection
        const nextButton = document.getElementById('nextButton');
        const recordButton = document.getElementById('recordButton');
        const submitButton = document.getElementById('submitButton');
        const questionTextElement = document.getElementById('questionText');
        const audioElement = document.getElementById('question-audio');
        const audioSource = document.getElementById('audioSource');

        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let recordingTimer;

        submitButton.disabled = true; // Reset the button state

        // Handle "Next" button click
        nextButton.addEventListener('click', () => {
            socket.emit('fetch_next_question', {}); // Request the next question
        });

        // Listen for the next question from the server
        socket.on('next_question', (data) => {
            if (data.status === 'success') {
                questionTextElement.textContent = data.question;
                audioSource.src = data.audio;
                audioSource.type = data.audioType || 'audio/mp3';
                audioElement.load();
                audioElement.play();
            } else if (data.status === 'completed') {
                alert(data.message);
                nextButton.disabled = true; // Disable the "Next" button
            } else {
                console.error('Error fetching next question:', data.message);
            }
        });

        // Handle "Record" button click
        recordButton.addEventListener('click', async () => {
            if (recordButton.textContent === 'Start Recording') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        clearInterval(recordingTimer);
                        submitButton.disabled = false; // Enable the "Submit Answer" button
                    };

                    mediaRecorder.start();
                    recordingStartTime = Date.now();
                    recordingTimer = setInterval(() => {
                        const elapsedTime = Math.floor((Date.now() - recordingStartTime) / 1000);
                        recordButton.textContent = `Stop Recording (${elapsedTime}s)`;
                    }, 1000);

                    recordButton.textContent = 'Stop Recording';
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('Microphone access is required to record your answer.');
                }
            } else {
                mediaRecorder.stop();
                clearInterval(recordingTimer);
                recordButton.textContent = 'Start Recording';
            }
        });

        // Handle "Submit Answer" button click
        submitButton.addEventListener('click', () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append('audio', audioBlob);

            // Send the audio to the backend
            fetch('/submit_answer_v2', {
                method: 'POST',
                body: formData,
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then((data) => {
                    console.log('Backend response:', data); // Debugging log
                    if (data.status === 'success') {
                        alert('Answer submitted successfully!');
                        submitButton.disabled = true; // Disable the "Submit Answer" button
                    } else {
                        console.error('Backend error:', data.message);
                        alert('Error submitting answer: ' + data.message);
                    }
                })
                .catch((error) => {
                    console.error('Network or server error:', error);
                    alert('Error submitting answer. Please try again.');
                });
        });
    });
</script>
{% endblock %}
